name: Capture Webpage

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Webpage URL to capture"
        required: true
        default: "https://example.com"
      output_filename:
        description: "Output filename (without .html extension)"
        required: false
        default: "captured-page"

permissions:
  contents: write

jobs:
  capture-webpage-html:
    name: Capture Webpage HTML with SingleFile
    runs-on: ubuntu-latest
    steps:
      - name: Print input values
        run: |
          echo "URL to capture: ${{ github.event.inputs.url }}"
          echo "Output filename: ${{ github.event.inputs.output_filename }}"
  
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build SingleFile Docker image
        working-directory: .
        run: |
          docker build -t singlefile -f ./single-file-cli.Dockerfile .

      - name: Set year variable
        id: set_year
        run: echo "year=$(date +%Y)" >> $GITHUB_OUTPUT

      - name: Capture webpage HTML, CSS & JS with SingleFile
        run: |
          # create dir in catalog/date/output_filename
          mkdir -p ./catalog/${{ steps.set_year.outputs.year }}/${{ github.event.inputs.output_filename }}
          docker run singlefile --browser-ignore-insecure-certs "${{ github.event.inputs.url }}" > "./catalog/${{ steps.set_year.outputs.year }}/${{ github.event.inputs.output_filename }}/index.html"

      - name: Upload captured webpage as artifact
        uses: actions/upload-artifact@v6
        with:
          name: captured-webpage
          path: ./catalog/${{ steps.set_year.outputs.year }}/${{ github.event.inputs.output_filename }}
          retention-days: 30

  capture-screenshot:
    name: Capture Screenshot with Puppeteer
    runs-on: ubuntu-latest
    steps:
      - name: Print input values
        run: |
          echo "URL to capture: ${{ github.event.inputs.url }}"
          echo "Output filename: ${{ github.event.inputs.output_filename }}"
  
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Puppeteer Screenshot Docker image
        working-directory: .
        run: |
          docker build -t puppeteer-screenshot -f ./puppeteer-screenshot.Dockerfile .

      - name: Set year variable
        id: set_year
        run: echo "year=$(date +%Y)" >> $GITHUB_OUTPUT

      - name: Capture screenshot with Puppeteer
        run: |
          # create dir in catalog/date/output_filename
          mkdir -p ./catalog/${{ steps.set_year.outputs.year }}/${{ github.event.inputs.output_filename }}
          docker run -v "${{ github.workspace }}/catalog:/usr/src/app/catalog" puppeteer-screenshot "${{ github.event.inputs.url }}" "/usr/src/app/catalog/${{ steps.set_year.outputs.year }}/${{ github.event.inputs.output_filename }}/screenshot.png"

      - name: Upload screenshot as artifact
        uses: actions/upload-artifact@v6
        with:
          name: captured-screenshot
          path: ./catalog/${{ steps.set_year.outputs.year }}/${{ github.event.inputs.output_filename }}
          retention-days: 30

  # fetch uploaded artifacts and unzip them and commit to repo
  commit-captured-data:
    runs-on: ubuntu-latest
    needs:
      - capture-webpage-html
      - capture-screenshot
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download captured webpage artifact
        uses: actions/download-artifact@v7
        with:
          name: captured-webpage
          path: ./temp-webpage
          
      - name: Download captured screenshot artifact
        uses: actions/download-artifact@v7
        with:
          name: captured-screenshot
          path: ./temp-screenshot

      - name: Move artifacts to catalog directory
        run: |
          YEAR=$(date +%Y)
          mkdir -p ./catalog/$YEAR/${{ github.event.inputs.output_filename }}
          mv ./temp-webpage/* ./catalog/$YEAR/${{ github.event.inputs.output_filename }}/
          mv ./temp-screenshot/* ./catalog/$YEAR/${{ github.event.inputs.output_filename }}/

      - name: Extract domain from URL
        id: extract_domain
        run: |
          DOMAIN=$(echo "${{ github.event.inputs.url }}" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "Extracted domain: $DOMAIN"

      - name: Update index.json
        run: |
          YEAR=$(date +%Y)
          URL="${{ github.event.inputs.url }}"
          DOMAIN="${{ steps.extract_domain.outputs.domain }}"
          FILENAME="${{ github.event.inputs.output_filename }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Read existing index.json
          INDEX_FILE="./catalog/index.json"

          python3 ./scripts/update_json.py "$INDEX_FILE" "$YEAR" "$URL" "$DOMAIN" "$FILENAME" "$TIMESTAMP"

          # Display updated index.json
          echo "Updated index.json:"
          cat "$INDEX_FILE"

      - name: Generate catalog HTML
        run: |
          python3 ./scripts/generate_catalog.py

      - name: Commit and push captured data
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ./catalog
          git commit -m "Add captured webpage and screenshot for ${{ github.event.inputs.url }}" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref }}