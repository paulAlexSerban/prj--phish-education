name: SingleFile Web Capture

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Webpage URL to capture"
        required: true
        default: "https://example.com"
      output_filename:
        description: "Output filename (without .html extension)"
        required: false
        default: "captured-page"

jobs:
  capture-webpage:
    runs-on: ubuntu-latest
    steps:
      - name: Print input values
        run: |
          echo "URL to capture: ${{ github.event.inputs.url }}"
          echo "Output filename: ${{ github.event.inputs.output_filename }}"
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build SingleFile Docker image
        working-directory: .
        run: |
          docker build -t singlefile -f ./single-file-cli.Dockerfile .

      - name: Capture webpage with SingleFile
        run: |
          # create dir in catalog/date/output_filename
          mkdir -p ./catalog/$(date +%Y)/${{ github.event.inputs.output_filename }}
          docker run singlefile "${{ github.event.inputs.url }}" > "./catalog/$(date +%Y)/${{ github.event.inputs.output_filename }}/index.html"

      - name: Extract domain from URL
        id: extract_domain
        run: |
          DOMAIN=$(echo "${{ github.event.inputs.url }}" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "Extracted domain: $DOMAIN"

      - name: Update index.json
        run: |
          YEAR=$(date +%Y)
          URL="${{ github.event.inputs.url }}"
          DOMAIN="${{ steps.extract_domain.outputs.domain }}"
          FILENAME="${{ github.event.inputs.output_filename }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Read existing index.json
          INDEX_FILE="./catalog/index.json"

          python3 ./scripts/update_json.py "$INDEX_FILE" "$YEAR" "$URL" "$DOMAIN" "$FILENAME" "$TIMESTAMP"

          # Display updated index.json
          echo "Updated index.json:"
          cat "$INDEX_FILE"

      - name: Upload captured webpage as artifact
        uses: actions/upload-artifact@v6
        with:
          name: captured-webpage
          path: ./catalog
          retention-days: 30

      # Requires credentials to push changes back to the repository from GitHub Actions
      # - name: Commit and push changes
      #   run: |
      #     git config --global user.name "github-actions[bot]"
      #     git config --global user.email "github-actions[bot]@users.noreply.github.com"
      #     git add ./catalog
      #     git commit -m "Add captured page: ${{ github.event.inputs.output_filename }} from ${{ steps.extract_domain.outputs.domain }}"
      #     git push
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
