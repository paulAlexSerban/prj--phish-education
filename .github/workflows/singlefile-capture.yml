name: Capture Webpage

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Webpage URL to capture"
        required: true
        default: "https://example.com"
      output_filename:
        description: "Output filename (without .html extension)"
        required: false
        default: "captured-page"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  capture-webpage-html:
    name: Capture Webpage HTML with SingleFile
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Print input values
        run: |
          echo "URL to capture: ${{ github.event.inputs.url }}"
          echo "Output filename: ${{ github.event.inputs.output_filename }}"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build SingleFile Docker image
        working-directory: .
        run: |
          docker build -t singlefile -f ./single-file-cli.Dockerfile .

      - name: Set year variable
        id: set_year
        run: echo "year=$(date +%Y)" >> $GITHUB_OUTPUT

      - name: Capture webpage HTML, CSS & JS with SingleFile
        continue-on-error: true
        run: |
          # create dir in catalog/date/output_filename
          mkdir -p ./catalog/${{ steps.set_year.outputs.year }}/${{ github.event.inputs.output_filename }}
          docker run singlefile --browser-ignore-insecure-certs "${{ github.event.inputs.url }}" > "./catalog/${{ steps.set_year.outputs.year }}/${{ github.event.inputs.output_filename }}/index.html" || echo "Failed to capture HTML"

      - name: Upload captured webpage as artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: captured-webpage
          path: ./catalog/${{ steps.set_year.outputs.year }}/${{ github.event.inputs.output_filename }}
          retention-days: 30
          if-no-files-found: warn

  capture-screenshot:
    name: Capture Screenshot with Puppeteer
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Print input values
        run: |
          echo "URL to capture: ${{ github.event.inputs.url }}"
          echo "Output filename: ${{ github.event.inputs.output_filename }}"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Puppeteer Screenshot Docker image
        working-directory: .
        run: |
          docker build -t puppeteer-screenshot -f ./puppeteer-screenshot.Dockerfile .

      - name: Set year variable
        id: set_year
        run: echo "year=$(date +%Y)" >> $GITHUB_OUTPUT

      - name: Capture screenshot with Puppeteer
        continue-on-error: true
        run: |
          # create dir in catalog/date/output_filename
          mkdir -p ./catalog/${{ steps.set_year.outputs.year }}/${{ github.event.inputs.output_filename }}
          # Retry up to 2 times on failure
          for i in 1 2; do
            docker run -v "${{ github.workspace }}/catalog:/usr/src/app/catalog" puppeteer-screenshot "${{ github.event.inputs.url }}" "/usr/src/app/catalog/${{ steps.set_year.outputs.year }}/${{ github.event.inputs.output_filename }}/screenshot.png" && break || echo "Attempt $i failed, retrying..."
            sleep 5
          done || echo "Failed to capture screenshot after retries"

      - name: Upload screenshot as artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: captured-screenshot
          path: ./catalog/${{ steps.set_year.outputs.year }}/${{ github.event.inputs.output_filename }}
          retention-days: 30
          if-no-files-found: warn

  # fetch uploaded artifacts and unzip them and commit to repo
  commit-captured-data:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: always()
    needs:
      - capture-webpage-html
      - capture-screenshot
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download captured webpage artifact
        continue-on-error: true
        uses: actions/download-artifact@v7
        with:
          name: captured-webpage
          path: ./temp-webpage

      - name: Download captured screenshot artifact
        continue-on-error: true
        uses: actions/download-artifact@v7
        with:
          name: captured-screenshot
          path: ./temp-screenshot

      - name: Move artifacts to catalog directory
        run: |
          YEAR=$(date +%Y)
          mkdir -p ./catalog/$YEAR/${{ github.event.inputs.output_filename }}

          # Move webpage artifact if it exists
          if [ -d "./temp-webpage" ] && [ "$(ls -A ./temp-webpage 2>/dev/null)" ]; then
            mv ./temp-webpage/* ./catalog/$YEAR/${{ github.event.inputs.output_filename }}/
            echo "✓ Webpage artifact moved"
          else
            echo "⚠ No webpage artifact found"
          fi

          # Move screenshot artifact if it exists
          if [ -d "./temp-screenshot" ] && [ "$(ls -A ./temp-screenshot 2>/dev/null)" ]; then
            mv ./temp-screenshot/* ./catalog/$YEAR/${{ github.event.inputs.output_filename }}/
            echo "✓ Screenshot artifact moved"
          else
            echo "⚠ No screenshot artifact found"
          fi

      - name: Extract domain from URL
        id: extract_domain
        run: |
          DOMAIN=$(echo "${{ github.event.inputs.url }}" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "Extracted domain: $DOMAIN"

      - name: Update index.json
        run: |
          YEAR=$(date +%Y)
          URL="${{ github.event.inputs.url }}"
          DOMAIN="${{ steps.extract_domain.outputs.domain }}"
          FILENAME="${{ github.event.inputs.output_filename }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Check if at least one file was captured
          if [ -f "./catalog/$YEAR/$FILENAME/index.html" ] || [ -f "./catalog/$YEAR/$FILENAME/screenshot.png" ]; then
            # Read existing index.json
            INDEX_FILE="./catalog/index.json"

            python3 ./scripts/update_json.py "$INDEX_FILE" "$YEAR" "$URL" "$DOMAIN" "$FILENAME" "$TIMESTAMP"

            # Display updated index.json
            echo "Updated index.json:"
            cat "$INDEX_FILE"
          else
            echo "⚠ No files were captured, skipping index.json update"
            exit 1
          fi

      - name: Generate catalog HTML
        continue-on-error: true
        run: |
          python3 ./scripts/generate_catalog.py || echo "⚠ Failed to generate catalog HTML"

      - name: Commit and push captured data
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ./catalog

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "⚠ No changes to commit"
            exit 0
          fi

          git commit -m "Add captured webpage and screenshot for ${{ github.event.inputs.url }}"

          # Retry push up to 3 times in case of conflicts
          for i in 1 2 3; do
            git push origin HEAD:${{ github.ref }} && break || {
              echo "Push attempt $i failed, pulling and retrying..."
              git pull --rebase origin ${{ github.ref }}
              sleep 2
            }
          done

  deploy-to-gh-pages:
    name: Deploy Catalog to GitHub Pages
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: commit-captured-data
    if: success()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload catalog to Pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./catalog

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
